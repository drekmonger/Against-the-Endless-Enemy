!function(){"use strict";var e,t=[];function n(n,a){var i,r=[];for(e=arguments.length;e-- >2;)t.push(arguments[e]);for(;t.length;)if(Array.isArray(i=t.pop()))for(e=i.length;e--;)t.push(i[e]);else null!=i&&!0!==i&&!1!==i&&r.push("number"==typeof i?i+="":i);return"string"==typeof n?{type:n,props:a||{},children:r}:n(a||{},r)}function a(e,t,n=100,a=!1){let i=[];i.push(t);for(let t=0;t<14;t++)for(let n=0;n<22;n++)e[t][n].distance=null,e[t][n].came_from=null;for(e[t.y][t.x].distance=0;i.length>0;){let t=i.shift();if(e[t.y][t.x].distance<n){let n=[];n.push({x:t.x,y:t.y-1}),n.push({x:t.x+1,y:t.y}),n.push({x:t.x,y:t.y+1}),n.push({x:t.x-1,y:t.y});for(let r of n)if(r.y>=0&&r.x>=0&&r.y<14&&r.x<22){let n=e[r.y][r.x];null===n.distance&&!n.wall&&(!n.occupied||n.occupied.isPlayer&&a)&&(i.push(r),n.distance=1+e[t.y][t.x].distance,n.came_from=t)}}}return{grid:e}}function i(e,t,n){let a=[],i=t;for(;null!=i;)a.unshift(i),i=n[i.y][i.x].came_from;return a.length>1?a:null}class r{constructor(e={}){this.duration=e.duration||1e3,this.ease=((e,t,n,a)=>n*e/a+t),this.start=e.start,this.end=e.end,this.frame=null,this.next=null,this.isRunning=!1,this.events={},this.directionX=this.start.x<this.end.x?"up":"down",this.directionY=this.start.y<this.end.y?"up":"down"}begin(){return this.isRunning||this.next===this.end||(this.frame=window.requestAnimationFrame(this._tick.bind(this))),this}stop(){return window.cancelAnimationFrame(this.frame),this.isRunning=!1,this.frame=null,this.timeStart=null,this.next=null,this}on(e,t){return this.events[e]=this.events[e]||[],this.events[e].push(t),this}emit(e,t){let n=this.events[e];n&&n.forEach(e=>e.call(this,t))}_tick(e){this.isRunning=!0;let t=this.next||this.start;this.timeStart||(this.timeStart=e),this.timeElapsed=e-this.timeStart,this.next={x:Math.round(this.ease(this.timeElapsed,this.start.x,this.end.x-this.start.x,this.duration)),y:Math.round(this.ease(this.timeElapsed,this.start.y,this.end.y-this.start.y,this.duration))},this._shouldTick(t)?(this.emit("tick",this.next),this.frame=window.requestAnimationFrame(this._tick.bind(this))):(this.emit("tick",this.end),this.emit("done",null))}_shouldTick(e){return{up:this.next.x<this.end.x&&e.x<=this.next.x,down:this.next.x>this.end.x&&e.x>=this.next.x}[this.directionX]||{up:this.next.y<this.end.y&&e.y<=this.next.y,down:this.next.y>this.end.y&&e.y>=this.next.y}[this.directionY]}}let s=e=>50*e-50,l=(e,t=!0)=>(e.supplies>0||0==t)&&e.phase<=3&&!e.pickGuild,o=()=>Math.random()>.8,c=(e,t)=>Math.hypot(t.tX-e.tX,t.tY-e.tY),p=(e,t,n)=>{let a=Math.abs(t.tX-e.tX),i=e.tX<t.tX?1:-1,r=Math.abs(t.tY-e.tY),s=e.tY<t.tY?1:-1,l=(a>r?a:-r)/2,o=!1,p={tX:e.tX,tY:e.tY};for(;;){if(n[p.tY][p.tX].wall){o=!0;break}if(p.tX===t.tX&&p.tY===t.tY)break;let e=l;e>-a&&(l-=r,p.tX+=i),e<r&&(l+=a,p.tY+=s)}return o?100:c(e,t)};function u(e){for(let t=e.length-1;t>0;t--){let n=Math.floor(Math.random()*(t+1)),a=e[t];e[t]=e[n],e[n]=a}}var h,d,m,f=({grid:e,hover:t,phase:a,unhover:i,select:r,init:l,pawns:o,line:c,cPawn:p,hPawn:u,skull:h,missle:d})=>{let m=[],f=[],g=[],y=[],w=[];for(let l=0;l<14;l++)for(let o=0;o<22;o++){let c=e[l][o],u=s(o),h=s(l);m.push(n("rect",{x:u,y:h,href:"#tile",width:"50",height:"50",key:c.tkeys,fill:c.grass,stroke:"#5A5353",onmouseover:e=>t({x:o,y:l}),onmouseleave:e=>i({x:o,y:l}),onclick:e=>r({x:o,y:l})})),c.wall>0&&f.push(n("rect",{x:u,y:h,href:"#tile",width:"50",height:"50",key:c.tkeys+1e3,fill:"#FFDEAD","pointer-events":"none"})),1==a&&null!=c.distance&&g.push(n("rect",{x:u,y:h,href:"#tile",width:"50",height:"50",key:c.tkeys,fill:c.occupied!=p?"rgba(0,100,0,0.2)":"rgba(0,200,0,0.8)","pointer-events":"none"}))}for(let e of o){let t=20;e.isPlayer&&e.special.range&&!e.isExhaust&&(t=50*e.special.range),w.push(n("use",{x:e.x,y:e.y,width:"50",height:"50",href:e.icon,fill:e.color,stroke:"black","stroke-width":"3","pointer-events":"none",key:e.key,filter:"url(#pf)"})),e===u&&w.push(n("circle",{cx:e.x+25,cy:e.y+25,r:t,fill:"white","fill-opacity":"0.2","pointer-events":"none"}))}if(1==a&&c){let e=c[0];for(let t of c)y.push(n("line",{x1:s(e.x)+25,y1:s(e.y)+25,x2:s(t.x)+25,y2:s(t.y)+25,"stroke-width":"3",stroke:"white","pointer-events":"none"})),e=t;y.push(n("use",{x:s(e.x)+7,y:s(e.y)+5,width:"35",height:"35",href:p.icon,fill:"white","pointer-events":"none"}))}return n("svg",{style:{position:"absolute",left:140,top:95,width:1e3,height:600,border:"10px solid #A07178",boxShadow:"0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19)"}},n("defs",null,n("filter",{id:"pf"},n("feDropShadow",{"flood-opacity":".3",dx:"3",dy:"3",stdDeviation:"0"})),n("filter",{id:"wf"},n("feMorphology",{operator:"erode",radius:"8"}),n("feDropShadow",{"flood-opacity":".7",dx:"3",dy:"3",stdDeviation:"2"}),n("feDropShadow",{"flood-opacity":".1",dx:"-3",dy:"-3",stdDeviation:"5"})),n("filter",{id:"gf"},n("feMorphology",{result:"r",in:"SourceGraphic",operator:"erode",radius:"5"}),n("feBlend",{result:"r2",in:"SourceGraphic",in2:"r",mode:"screen"})),n("symbol",{id:"p",viewBox:"0 0 512 512"},n("path",{d:"M263 18h-3c-33 0-60 34-60 76 0 21 7 40 18 54-68 11-83 105-67 192h24l-1-105h19l1 127 9 133h47V319h19v176h44l12-154 1-106h19l-1 105h25c18-88-5-179-67-191 12-14 19-33 19-55 0-39-23-72-53-76h-2"})),n("symbol",{id:"m1",viewBox:"0 0 512 512"},n("path",{d:"M0 0h512v512H0z",fill:"none"}),n("path",{d:"M323 144l-14 1c19 33 6 75-19 108-10-94-17-19-36-20-19 0-22-77-34 9-20-37-27-78-14-95C89 142 19 237 5 293c27-27 116-19 128 15 17-23 52-30 83-29-1 21 18 22 38 22s39-1 38-23c33-4 71 3 89 27 13-33 101-42 129-14-41-82-93-147-187-147z"})),n("symbol",{id:"m2",viewBox:"0 0 512 512"},n("path",{d:"M260 19c-74 0-134 52-134 112 17 56 39 80 40 139 60-51 23 54 11 74-146 119-128-51-87-13-75-132-161 199 112 74 6 139 177 72 100 14 9 42-48 47-49-13 0-23 11-43 27-57 149 290 301-142 131-4 67 3-10 114-65-1-12-38-52-109 8-74-19-56 38-90 39-139 0-60-58-112-133-112z"})),n("symbol",{id:"m3",viewBox:"0 0 512 512"},n("path",{d:"M148 252l54-34c47 77 4 93-52 153l13 86-43 52h53l22-50c-15-135 176-110 184 1l-11 49h69l-34-49-6-74c-84-70-91-81-59-178l68 23c-86 88-33 76 41-6-63-36-115-57-131-118 61-14 68-74 17-106 10 29 25 56-37 71-17-15-36-13-51 0-65-15-49-42-39-71-53 33-44 94 20 107 3 57-33 72-81 111-186-109-95-22 3 33z"})),n("symbol",{id:"m4",viewBox:"0 0 512 512"},n("path",{d:"M61 7c-6 73 67 87 117 115-183 3-208 247-51 262 52-42-9-109-57-61 5-163 111-30 119 57-61 58-23 99-98 134h107c-63-129 176-114 95 0h106c-81-20-47-104-98-134-8-137 197-195 113-61-48-48-105 23-52 65 283-99 40-269-42-260C372 94 465 56 442 7 376 117 75 60 61 7z"})),n("symbol",{id:"sk",viewBox:"0 0 512 512"},n("path",{d:"M5 197c0 50 23 97 63 133 19 34 9 92 11 134 9 5 29 15 59 25v-81h37v90c20 4 43 8 68 8v-83h37v83c26-1 50-5 70-10v-88h37v78c23-9 39-17 47-22 12-34-17-109 9-133 41-36 65-83 65-134C472-84 13-38 5 197zm209 10a78 78 0 0 1-156 0c21-69 111-23 156 0zm241 0a78 78 0 1 1-156 0c43-18 152-66 156 0z"}))),n("g",null,m),n("g",{filter:"url(#wf)"},f),n("g",{filter:"url(#gf)"},g),n("g",{opacity:".8"},y),w,h&&n("use",{use:!0,x:s(h.tX),y:s(h.tY),width:"50",height:"50",href:"#sk",fill:"Ivory",filter:"url(#pf)","pointer-events":"none"}),d&&4==a&&n("rect",{x:d.x+25,y:d.y+25,rx:20*d.r,ry:20*d.r,height:2+d.a,width:2+d.a,fill:d.c,stroke:"black","pointer-events":"none"}))},g=({pawn:e,guild:t,i:a,current:i,highlight:r,hover:s,unhover:l})=>{const o={top:130*a+95,background:r?e.color:"none"},c={background:i?"#A07178":"none",color:i?"white":"black",textShadow:i?"1px 1px #050505":"none"};let p=e.fatigue;return n("div",{style:o,class:"cc",onmouseover:t=>s(e),onmouseleave:l},n("div",{style:c,class:"ct"},i?">"+e.guild+"<":e.guild),n(y,{s:"Armor",a:e.aegis,max:t.aegis}),n(y,{s:"Health",a:e.health,max:t.health}),100!=p&&n(y,{s:"Fatigue",a:p,fa:!0}),100==p&&n(y,{s:"FATIGUED!",a:"100",fa:!0}),n(y,{s:"Attack",a:e.attack}),n(y,{s:"Move",a:e.move,b:!1}))};const y=({s:e,a:t,max:a=!1,b:i=!0,fa:r=!1})=>{return n("div",{class:"cr",style:{borderBottom:i?"1px solid #A07178":"none"},a:t,oncreate:e=>e.style.background="inherit",onupdate:(e,n)=>{if(n.a!=t){e.style.background=r?n.a<t?"LightCoral":"Lime":n.a>t?"LightCoral":"Lime",e.style.color="White";setTimeout(()=>{e.style.background="inherit",e.style.color="inherit"},1400)}}},n("div",{class:"ca"},e),n("div",{class:"ca"},t<100&&t,a&&n("span",{class:"cam"},"|",a)))};var w=({actList:e})=>{let t=[];for(let a of e){const e={top:s(a.t.tY),left:s(a.t.tX)};t.push(n("button",{style:e,onclick:e=>a.a(a.t),class:"act"}," ",a.d," "))}return n("div",{style:{position:"absolute",top:132,left:150,margin:0}},t)},v=({camp:e,restFN:t,forageFN:a,patrolFN:i,trainFN:r,guildFN:s,battleFN:l})=>{let o=()=>3!=e.phase&&0==e.pickGuild;return n("div",{style:{position:"absolute",left:140,top:75},class:"campd"},n("h2",null," Supplies: ",e.supplies," "),n("div",null,"Morning: ",e.phaseReport[0]," "),n("div",null,"Noon: ",e.phaseReport[1]," "),n("div",null,"Afternoon: ",e.phaseReport[2]," "),n("br",null),o()&&n(x,{label:"REST",desc:"regain twenty stamina, repair five armor, heal one health",supplies:e.supplies,fn:t}),o()&&n(x,{label:"FORAGE",desc:"find supplies",supplies:e.supplies,fn:a,cost:!1}),o()&&n(x,{label:"TRAIN",desc:"recruit a new defender (max five defenders) ("+(4-e.train)+" more needed)",supplies:e.supplies,fn:r}),o()&&0==e.patrolKills&&n(x,{label:"PATROL",desc:"slay sleeping monsters",supplies:e.supplies,fn:i}),e.pickGuild&&n("div",{class:"campd"},n("h2",null," A new defender joins. Select a guild:"),e.pickGuild.map(e=>n("button",{class:"camp",onclick:t=>s(e.ID)},n("h1",{class:"camph"},e.desc)))),3==e.phase&&n(x,{label:"TO BATTLE",desc:"the monsters awaken",fn:l,supplies:e.supplies,cost:!1}))};let x=({label:e,desc:t,fn:a,supplies:i,cost:r=!0})=>{let s=!1;return r&&0==i&&(s=!0),n("button",{class:"camp",onclick:e=>a(),disabled:s},r&&n("span",null,"costs one supply"),n("h1",{class:"camph"},e),t)};let k=({msgt:e,msg:t,msgb:a,fn:i})=>{return n("button",{class:"camp",onclick:e=>i(),style:{position:"absolute",left:290,top:55}},e,n("h1",null,t),a)};!function(e,t){var a,i,r,s=(t=t||document.body).children[0],l=function e(t,a){return t&&n(t.tagName.toLowerCase(),{},a.call(t.childNodes,function(t){return 3===t.nodeType?t.nodeValue:e(t,a)}))}(s,[].map),o=[];return c(u(function e(t,n,a){t.init&&o.push(function(){t.init(n,a)}),h(n,t.state),function e(t,n,a){Object.keys(a||{}).map(function(r){"function"==typeof a[r]?n[r]=function(e){return"function"==typeof(e=a[r](t,n,e))?e(i):i(e)}:e(t[r]||(t[r]={}),n[r]={},a[r])});function i(e){return"function"==typeof e?i(e(t)):e&&c(h(t,e)),t}}(n,a,t.actions);for(var i in t.modules)e(t.modules[i],n[i]={},a[i]={})}(e,i={},r={}))),r;function c(){e.view&&!a&&requestAnimationFrame(p,a=!a)}function p(){u(s=function e(t,n,a,i,r,s){if(null==a)n=t.insertBefore(m(i,r),n);else if(null!=i.type&&i.type===a.type){!function(e,t,n){for(var a in d(t,n)){var i=n[a],r="value"===a||"checked"===a?e[a]:t[a];i!==r&&i!==r&&f(e,a,i,r)}n&&n.onupdate&&o.push(function(){n.onupdate(e,t)})}(n,a.props,i.props),r=r||"svg"===i.type;for(var l=i.children.length,c=a.children.length,p={},u=[],h={},w=0;w<c;w++){var v=u[w]=n.childNodes[w],x=a.children[w],k=y(x);null!=k&&(p[k]=[v,x])}for(var w=0,P=0;P<l;){var v=u[w],x=a.children[w],b=i.children[P],k=y(x);if(h[k])w++;else{var A=y(b),M=p[A]||[];null==A?(null==k&&(e(n,v,x,b,r),P++),w++):(k===A?(e(n,M[0],M[1],b,r),w++):M[0]?(n.insertBefore(M[0],v),e(n,M[0],M[1],b,r)):e(n,v,null,b,r),P++,h[A]=b)}}for(;w<c;){var x=a.children[w],k=y(x);null==k&&g(n,u[w],x.props),w++}for(var w in p){var M=p[w],F=M[1];h[F.props.key]||g(n,M[0],F.props)}}else n&&i!==n.nodeValue&&("string"==typeof i&&"string"==typeof a?n.nodeValue=i:(n=t.insertBefore(m(i,r),s=n),g(t,s,a.props)));return n}(t,s,l,l=e.view(i,r),a=!a))}function u(e){for(;e=o.pop();)e()}function h(e,t){for(var n in t)e[n]=t[n];return e}function d(e,t){return h(h({},e),t)}function m(e,t){if("string"==typeof e)var n=document.createTextNode(e);else{n=(t=t||"svg"===e.type)?document.createElementNS("http://www.w3.org/2000/svg",e.type):document.createElement(e.type),e.props&&e.props.oncreate&&o.push(function(){e.props.oncreate(n)});for(var a=0;a<e.children.length;a++)n.appendChild(m(e.children[a],t));for(var a in e.props)f(n,a,e.props[a])}return n}function f(e,t,n,a){if("key"===t);else if("style"===t)for(var t in d(a,n=n||{}))e.style[t]=n[t]||"";else{try{e[t]=n}catch(e){}"function"!=typeof n&&(n?e.setAttribute(t,n):e.removeAttribute(t))}}function g(e,t,n){n&&n.onremove&&"function"==typeof(n=n.onremove(t))?n(a):a();function a(){e.removeChild(t)}}function y(e){if(e&&e.props)return e.props.key}}({state:{gameStatus:0,day:1,initative:[],currentPawn:null,turnPhase:0,actList:[],skull:null,missle:null,camp:{supplies:4,train:0,patrolKills:0,pickGuild:!1,phase:0,phaseReport:["","",""]},maps:[[0xfffffe3bffd,9071212105777,0xc4e00637c81,0xdce706313e1,0xc407264009d,0xb8202641c01,8863176720383],[0xffffffffc01,0xc00117207c5,0xef83b600081,8843931165705,0xf08227e3c89,0xfc0227f80fd,0xfe7007fffff],[0xffffffff83d,0xf1e86606301,8803884060609,9326594942993,8933756383349,9674353522689,0x9e01e7fffff],[0xffffff80821,0xe324a78c909,0xf324860c3a9,9006049459753,0xb700a600e89,0xdf0a867fa29,8798282448895]],grid:{},playerSpawn:[{x:1,y:5},{x:2,y:6},{x:1,y:7},{x:3,y:5},{x:3,y:7}],pawns:[],enemies:[],start:{},magicLine:null,monsterPoints:3,tHovered:null,tTimer:null,pHovered:null,guilds:[{desc:"Warrior",color:"#D3D3D3",attack:5,move:5,health:7,aegis:10,special:{desc:"",cost:0,range:0,attack:2}},{desc:"Mage",color:"#00BFFF",attack:1,move:5,health:3,aegis:3,special:{desc:"zap",cost:15,range:6,attack:6}},{desc:"Archer",color:"#8FBC8F",attack:4,move:7,health:5,aegis:4,special:{desc:"arrow",cost:8,range:5,attack:4}},{desc:"Rogue",color:"Khaki",attack:5,move:9,health:5,aegis:3,special:{desc:"knife",cost:5,range:3,attack:3}},{desc:"Beserk",color:"#D2691E",attack:6,move:6,health:18,aegis:1,special:{desc:"",cost:3,range:0,attack:2}},{desc:"Witch",color:"#FFB6C1",attack:2,move:5,health:3,aegis:2,special:{desc:"doom",cost:30,range:3,attack:20}},{desc:"Golem",color:"#708090",attack:5,move:3,health:1,aegis:15,special:{desc:"",cost:0,range:0,attack:0}},{desc:"Amazon",color:"#FF69B4",attack:5,move:6,health:10,aegis:3,special:{desc:"spear",cost:6,range:2,attack:5}},{desc:"Clown",color:"Orange",attack:1,move:6,health:4,aegis:2,special:{desc:"joke",cost:0,range:3,attack:1}}],monsters:[{cost:1,attack:2,range:1,move:7,health:3,icon:"#m1"},{cost:2,attack:2,range:6,move:4,health:6,icon:"#m2"},{cost:3,attack:3,range:1,move:4,health:8,icon:"#m3"},{cost:5,attack:5,range:1,move:3,health:15,icon:"#m4"}]},actions:{gameInit:(e,t,n)=>{t.gameInitialState(),t.pawnCreate(0),t.pawnCreate(1),t.pawnCreate(2),t.mapInit(),console.log(e)},gameInitialState:e=>{let t=e.camp;return t.supplies=4,t.train=0,{camp:t,day:0,pawns:[],enemies:[]}},gameOver:(e,t)=>({gameStatus:3}),turnBegin:(e,t)=>{t.turnSpawnEnemies(),t.turnInitialState(),t.turnNextPawn()},turnSpawnEnemies:(e,t)=>{let n=e.grid,a=e.monsters,i=e.monsterPoints,r=[];for(let e=1;e<12;e++)n[e][21].occupied||r.push(e);if(r.length>0){u(r);let n=Math.floor(4*Math.random());for(let s=0;s<=n;s++)if(i>0){let n=Math.floor(4*Math.random());if((a[n].cost>i||e.day<3&&3==n)&&(n=0),i-=a[n].cost,t.monsterCreate({gID:n,tX:21,tY:r.pop()}),0==r.length||0==i)break}}return{monsterPoints:i,enemies:[...e.enemies]}},turnInitialState:e=>({turnPhase:0,currentPawn:null,initiative:[...e.enemies,...e.pawns]}),turnNextPawn:(e,t)=>{if(0==e.initiative.length)t.turnBegin();else{let n=e.initiative.shift();n.isPlayer?t.turnPhaseMove(n):t.turnEnemy(n)}},turnPhaseMove:(e,t,n)=>{let i=[...e.grid];return a(i,{x:n.tX,y:n.tY},n.move,!0),{turnPhase:1,currentPawn:n,grid:i}},turnPhaseAction:(e,t)=>{let n=[],a=e.currentPawn,i=e.enemies;for(let r of i){let i=p(a,r,e.grid);1==i?n.push({a:t.pawnMelee,d:"attack",t:r}):i<=a.special.range&&!a.isExhaust&&n.push({a:t.pawnSpecial,d:a.special.desc,t:r})}return 0==n.length?(t.pawnDoNothing(),null):(n.push({a:t.pawnDoNothing,d:"rest",t:a}),{turnPhase:3,actList:n})},turnEnemy:(e,t,n)=>{t.turnEnemyInit(n);let r=n.range,s=e.pawns,l=e.grid,o=[];if(1==n.range&&21!=n.tX){for(let e of s)c(e,n)<=1&&o.push(e);if(o.length>0)return t.turnEnemyAction(n),null}o=[];for(let e of s){a(l,{x:e.tX,y:e.tY});for(let e of l)for(let t of e)t.distance&&t.distance==r&&o.push(t)}if(0==o.length)return t.turnEnemyAction(n),null;o=o.map(e=>({x:e.id.x,y:e.id.y}));a(l,{x:n.tX,y:n.tY});for(let e of o)e.d=l[e.y][e.x].distance?l[e.y][e.x].distance:100;if(o.sort((e,t)=>e.d-t.d),100==o[0].d)t.turnEnemyAction(n);else{let e=i((n.tX,n.tY),o[0],l).slice(0,n.move+1).slice(-1)[0];t.pawnMove(e)}},turnEnemyInit:(e,t,n)=>({turnPhase:5,currentPawn:n}),turnEnemyAction:(e,t,n)=>{let a=e.pawns,i=[];for(let e of a)c(e,n)<=n.range&&i.push(e);if(i.length>0){i.length>1&&u(i);let e=0;return n.range>1&&(e=1),t.pawnDoAttack({t:i[0],a:n.attack,r:e,c:"Red"}),null}t.turnDone()},turnDone:(e,t)=>0==e.enemies.length&&0==e.monsterPoints?{gameStatus:3,turnPhase:10}:0==e.pawns?{gameStatus:4,turnPhase:10}:void t.turnNextPawn(),mapInit:(e,t)=>{t.mapInitialState(),t.turnBegin()},mapInitialState:e=>{let t=[...e.maps];u(t);let n=t[0],a="";for(let e of n)a+=e.toString(2);n=[];for(let e=0;e<14;e++){let t=[];for(let n=0;n<22;n++){let i=22*e+n;t.push(+a.slice(i,i+1))}n.push(t)}let i=[],r=[];for(let e=0;e<14;e++){r=[];for(let t=0;t<22;t++){let a=Math.round(13*Math.random())-6*n[e][t],i={wall:n[e][t],grass:(h=177+a,d=182+a,m=149+a,["rgb(",h,",",d,",",m,")"].join("")),tkeys:t+22*e,occupied:!1,id:{x:t,y:e}};r.push(i)}i.push(r)}let l=[],o=[...e.playerSpawn];u(o);let c=0;for(let t of e.pawns){let e=o[c];t.tX=e.x,t.tY=e.y,t.x=s(t.tX),t.y=s(t.tY),i[e.y][e.x].occupied=t,l.push(t),c++}let p=5+e.day-e.camp.patrolKills;return{day:e.day+1,gameStatus:1,grid:i,pawns:l,enemies:[],monsterPoints:p}},mapTileHover:(e,t,n)=>{let a=e.grid[n.y][n.x],r=e.currentPawn;return e.tTimer&&a.distance&&!a.occupied&&clearTimeout(e.tTimer),a.occupied&&a.occupied.isPlayer&&t.mapPawnHover(a.occupied),1===e.turnPhase&&a.distance&&!a.occupied?{magicLine:i((r.tX,r.tY),n,e.grid),tHovered:n,tTimer:null}:null},mapTileUnhover:(e,t,n)=>{if(e.pHovered&&t.mapPawnUnhover(),e.magicLine&&!e.tTimer){return{tTimer:setTimeout(()=>t.mapRemoveLine(),20)}}},mapRemoveLine:()=>({tTimer:null,magicLine:null}),mapTileClick:(e,t,n)=>{let a=e.grid[n.y][n.x];1==e.turnPhase&&!a.occupied&&a.distance&&t.pawnMove(n),1==e.turnPhase&&a.occupied==e.currentPawn&&t.turnPhaseAction()},mapPawnHover:(e,t,n)=>({pHovered:n}),mapPawnUnhover:()=>({pHovered:null}),mapSetSkull:(e,t,n)=>(n&&setTimeout(()=>t.mapSetSkull(null),1200),{skull:n}),pawnCreate:(e,t,n)=>{let a=e.guilds[n],i={guild:a.desc,gID:n,aegis:a.aegis,fatigue:0,attack:a.attack,move:a.move,health:a.health,special:a.special,isExhaust:!1,tX:0,tY:0,x:0,y:0,color:a.color,key:Math.random(),icon:"#p",isPlayer:!0};return{pawns:[...e.pawns,i]}},pawnMove:(e,t,n)=>{let a=e.currentPawn;return function e({start:t,arr:n,tickFN:a,endFN:i,duration:s,first:l=!0}){let o=n[0];new r({start:t,end:o,duration:s}).on("tick",e=>a(e)).on("done",()=>{1==n.length?i():e({start:o,arr:n.slice(1),tickFN:a,endFN:i,duration:s,first:!1})}).begin()}({start:{x:a.x,y:a.y},arr:i((a.tX,a.tY),n,e.grid).map(e=>({x:s(e.x),y:s(e.y)})),tickFN:t.pawnMoveUpdate,endFN:t.pawnMoveDone,duration:50}),e.grid[a.tY][a.tX].occupied=null,a.tX=n.x,a.tY=n.y,e.grid[a.tY][a.tX].occupied=a,a.isPlayer&&t.pawnFatigue({pawn:a,m:2}),{turnPhase:2,currentPawn:a,magicLine:null}},pawnMoveUpdate:(e,t,n)=>{let a=e.currentPawn;return a.x=n.x,a.y=n.y,{currentPawn:a}},pawnMoveDone:(e,t)=>{e.currentPawn.isPlayer?(e.tHovered&&(t.mapPawnUnhover(),t.mapTileHover(e.tHovered)),t.turnPhaseAction()):t.turnEnemyAction(e.currentPawn)},pawnDoNothing:(e,t)=>{t.turnDone()},pawnMelee:(e,t,n)=>{let a=e.currentPawn;t.pawnFatigue({pawn:a,m:6}),t.pawnDoAttack({t:n,a:a.attack,r:0,c:a.color})},pawnSpecial:(e,t,n)=>{let a=e.currentPawn,i=a.special;a.isPlayer&&t.pawnFatigue({pawn:a,m:i.cost}),t.pawnDoAttack({t:n,a:i.attack,r:1,c:a.color})},pawnDoAttack:(e,t,{t:n,a,r:i,c:s})=>{let l=e.currentPawn,o={x:l.x,y:l.y,t:n,a,r:i,c:s};e.missle=o;new r({start:{x:l.x,y:l.y},end:{x:n.x,y:n.y},duration:170+20*c({tX:l.tX,tY:l.tY},{tX:n.tX,tY:n.tY})}).on("tick",e=>t.pawnUpdateMissle(e)).on("done",e=>t.pawnFinishAttack(e)).begin();return{missle:o,actList:[],turnPhase:4}},pawnUpdateMissle:(e,t,n)=>{let a=e.missle;return a.x=n.x,a.y=n.y,{missle:a}},pawnFinishAttack:(e,t,n)=>{t.pawnHurt({pawn:e.missle.t,m:e.missle.a}),t.turnDone()},pawnFatigue:(e,t,n)=>(n.pawn.fatigue+=n.m,n.pawn.fatigue<0&&(n.pawn.fatigue=0),n.pawn.fatigue>=100?(n.pawn.fatigue=100,n.pawn.isExhaust=!0):n.pawn.isExhaust=!1,{pawns:[...e.pawns]}),pawnHurt:(e,t,n)=>{let a=n.pawn;return a.isPlayer?(a.isExhaust?n.m*=2:t.pawnFatigue(n),a.aegis-=n.m,a.aegis>0?{pawns:[...e.pawns]}:(a.health+=a.aegis,a.aegis=0,a.health<1&&t.pawnDeath(a),{pawns:[...e.pawns],missle:null})):(t.monsterHurt(n),null)},pawnDeath:(e,t,n)=>{n.health=0,t.mapSetSkull({tX:n.tX,tY:n.tY}),e.grid[n.tY][n.tX].occupied=null;let a=e.initiative.indexOf(n);a>-1&&e.initiative.splice(a,1),n.isPlayer?(a=e.pawns.indexOf(n),e.pawns.splice(a,1)):(a=e.enemies.indexOf(n),e.enemies.splice(a,1))},monsterCreate:(e,t,{gID:n,tX:a,tY:i})=>{let r=e.monsters[n],l={gID:n,attack:r.attack,range:r.range,move:r.move,health:r.health,tX:a,tY:i,x:s(a),y:s(i),color:"LightCoral",key:Math.random(),icon:r.icon,isPlayer:!1,needsSpawn:!0};return e.grid[i][a].occupied=l,{enemies:[...e.enemies,l]}},monsterHurt:(e,t,n)=>{let a=n.pawn;return a.health-=n.m,a.health<1&&t.pawnDeath(a),{enemies:[...e.enemies]}},campInit:(e,t)=>{let n=e.camp;return n.phase=0,n.patrolKills=0,n.phaseReport=["","",""],{gameStatus:2,turnPhase:6,currentPawn:null,camp:n,pawns:[...e.pawns]}},campAdvance:(e,t,n)=>{let a=e.camp;return a.phaseReport[a.phase]=n.report,a.supplies-=n.cost,a.pickGuild=!1,a.phase++,{camp:a}},campRest:(e,t)=>{if(!l(e.camp))return null;for(let n of e.pawns){t.pawnFatigue({pawn:n,m:-20});let a=e.guilds[n.gID];n.aegis+=5,n.aegis>a.aegis&&(n.aegis=a.aegis),n.health+=1,n.health>a.health&&(n.health=a.health)}return t.campAdvance({cost:1,report:"The defenders rested."}),{pawns:[...e.pawns]}},campForage:(e,t)=>{if(!l(e.camp,!1))return null;o()?t.campAdvance({cost:0,report:"Sadly, no supplies were found..."}):o()?t.campAdvance({cost:-3,report:"A cache of supplies was found."}):t.campAdvance({cost:-2,report:"A few supplies were found."})},campTrain:(e,t)=>{if(!l(e.camp))return null;let n=e.camp;if(n.train+1==4&&5==e.pawns.length)return null;t.campAddTraining(),4==n.train?t.campTrainComplete():t.campAdvance({cost:1,report:"Training progresses..."})},campAddTraining:e=>{let t=e.camp;return t.train++,{camp:t}},campTrainComplete:e=>{let t=e.camp,n=e.guilds.map((e,t)=>({ID:t,desc:e.desc}));return u(n),t.pickGuild=[n[0],n[1],n[2]],t.train=0,{camp:t}},campPickGuild:(e,t,n)=>{t.pawnCreate(n),t.campAdvance({cost:1,report:e.guilds[n].desc+" has joined the defenders."})},campPatrol:(e,t)=>{if(!l(e.camp))return null;o()?t.campAdvance({cost:1,report:"The patrol found no sleeping monsters to murder."}):o()?(t.campKillMons(4),t.campAdvance({cost:1,report:"A large den of monsters were slain while they slumbered."})):(t.campKillMons(Math.floor(3*Math.random())+1),t.campAdvance({cost:1,report:"A few sleeping monsters were found and slain."}))},campKillMons:(e,t,n)=>{let a=e.camp;return a.patrolKills=n,{camp:a}},campToMap:(e,t)=>{t.mapInit()}},view:(e,t)=>{let a=e.gameStatus;return n("main",null,0==a&&n("div",null,n("h1",null,"Against the Endless Enemy"),n("br",null),n("button",{onclick:t.gameInit,class:"camp"},"how long can you survive...?",n("h1",{class:"camph"},"Begin"))),a>0&&n("h1",null,"Day ",e.day," ",2==a&&n("span",null," --- Camp ")),a>0&&n("div",null,e.pawns.map((a,i)=>n(g,{pawn:a,guild:e.guilds[a.gID],i,current:a==e.currentPawn,highlight:e.pHovered==a,hover:t.mapPawnHover,unhover:t.mapPawnUnhover}))),(1==a||a>2)&&n(f,{grid:e.grid,pawns:[...e.pawns,...e.enemies],phase:e.turnPhase,line:e.magicLine,cPawn:e.currentPawn,hPawn:e.pHovered,skull:e.skull,missle:e.missle,hover:t.mapTileHover,unhover:t.mapTileUnhover,select:t.mapTileClick}),3==e.turnPhase&&n(w,{actList:e.actList}),2==a&&n(v,{camp:e.camp,restFN:t.campRest,forageFN:t.campForage,patrolFN:t.campPatrol,trainFN:t.campTrain,guildFN:t.campPickGuild,battleFN:t.campToMap}),3==a&&n(k,{msgt:"the monsters have been beaten back",msg:"VICTORY",msgb:"proceed to camp...",fn:t.campInit}),4==a&&n(k,{msgt:"you survived for "+e.day+" days",msg:"DEFEAT",msgb:"play again?",fn:t.gameInit}))}})}();
